\doxysection{Flowmeter.\+cpp}
\hypertarget{_flowmeter_8cpp_source}{}\label{_flowmeter_8cpp_source}\index{app/Drivers/Flowmeter/Flowmeter.cpp@{app/Drivers/Flowmeter/Flowmeter.cpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}Flowmeter.hpp"{}}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00003}00003\ \textcolor{preprocessor}{\#include\ "{}micros.h"{}}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00004}00004\ \textcolor{preprocessor}{\#include\ "{}SimpleKalmanFilter.h"{}}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00005}00005\ \textcolor{preprocessor}{\#include\ "{}Settings.hpp"{}}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00007}00007\ \textcolor{preprocessor}{\#define\ kalmanR\ 0.15f}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00008}00008\ \textcolor{preprocessor}{\#define\ kalmanQ\ 0.15f}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00009}00009\ \textcolor{preprocessor}{\#define\ kalmanA\ 1.0f}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00011}00011\ \textcolor{keyword}{using\ namespace\ }App::Drivers;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00012}00012\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00013}00013\ \doxymbox{\hyperlink{class_simple_kalman_filter}{SimpleKalmanFilter}}\ kalmanFilter(kalmanR,\ kalmanQ,\ kalmanA);\ \textcolor{comment}{//\ Example\ parameters}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00014}00014\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00015}00015\ Flowmeter::Flowmeter(uint16\_t\ flowmeterFactor,\ \textcolor{keywordtype}{float}\ tankCapacity)\ :\ flowmeterK(flowmeterFactor),\ tankCapacity(tankCapacity)\ \{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00016}00016\ \ \ \ \ volume\ =\ tankCapacity;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00017}00017\ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00019}\doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_ad50d63a4c90db07236a9619e84a423f2}{00019}}\ \textcolor{keywordtype}{float}\ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_ad50d63a4c90db07236a9619e84a423f2}{Flowmeter::getFlowRate}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00020}00020\ \ \ \ \ \textcolor{keywordflow}{return}\ flowrate;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00021}00021\ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00023}\doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a8f0e301f70c6bc5d2b3661098a23d1eb}{00023}}\ \textcolor{keywordtype}{float}\ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a8f0e301f70c6bc5d2b3661098a23d1eb}{Flowmeter::getVolume}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00024}00024\ \ \ \ \ \textcolor{keywordflow}{return}\ volume;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00025}00025\ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00027}\doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_ae2e62d05edabe23f9880204b2c29acc6}{00027}}\ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_ae2e62d05edabe23f9880204b2c29acc6}{Flowmeter::onTimerOverflow}}()\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00028}00028\ \ \ \ \ overflowCount++;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00029}00029\ \ \ \ \ \textcolor{keywordflow}{if}\ (overflowCount\ >\ 30)\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00030}00030\ \ \ \ \ \ \ \ \ flowrate\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00031}00031\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00032}00032\ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00034}\doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a26d246dfb3c5b8e14f6846bbe7db90c4}{00034}}\ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a26d246dfb3c5b8e14f6846bbe7db90c4}{Flowmeter::onPulse}}(uint32\_t\ time)\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00035}00035\ \ \ \ \ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_abb5c9924f17b9ee21c9f394b026063d3}{calculateDuration}}(overflowCount*0xFFFF\ +\ time);}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00036}00036\ \ \ \ \ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a9496bec21e4d0850eb67cae32fbe592e}{calculateFlow}}();}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00037}00037\ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00044}\doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_abb5c9924f17b9ee21c9f394b026063d3}{00044}}\ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_abb5c9924f17b9ee21c9f394b026063d3}{Flowmeter::calculateDuration}}(uint32\_t\ time)\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00045}00045\ \ \ \ \ uint32\_t\ duration\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00046}00046\ \ \ \ \ duration\ =\ outlierFilter.filter(time\ -\/\ lastCaptureTime);}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00047}00047\ \ \ \ \ duration\ =\ maFilter.filter(duration);}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00048}00048\ \ \ \ \ duration\ =\ oaFilter.filter(duration);}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00049}00049\ \ \ \ \ pulseWidth\ =\ duration;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00050}00050\ \ \ \ \ lastCaptureTime\ =\ time;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00051}00051\ \}}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00057}\doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a9496bec21e4d0850eb67cae32fbe592e}{00057}}\ \textcolor{keywordtype}{void}\ \doxymbox{\hyperlink{class_app_1_1_drivers_1_1_flowmeter_a9496bec21e4d0850eb67cae32fbe592e}{Flowmeter::calculateFlow}}()\{}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00058}00058\ \ \ \ \ rawFlowrate\ =\ ((1e6\ /\ pulseWidth)\ *\ PUSLECOUNTPERDURATION\ /\ flowmeterK)\ *\ 60.0f;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00059}00059\ \ \ \ \ flowrate\ =\ kalmanFilter.updateEstimate(rawFlowrate);}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00060}00060\ \ \ \ \ volume\ -\/=\ 10.0f\ /\ flowmeterK;}
\DoxyCodeLine{\Hypertarget{_flowmeter_8cpp_source_l00061}00061\ \}}

\end{DoxyCode}
